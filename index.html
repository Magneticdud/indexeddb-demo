<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN" "http://www.w3.org/TR/html4/loose.dtd"> 
<html lang="en">
	<head>
		<meta http-equiv="content-type" content="text/html; charset=utf-8">
		<title>Title Goes Here</title>
		<script type="text/javascript">
			//global variable for indexedDB support
			var idbSupported = false;
			var db;
			//check for indexedDB 
			//if supported, indexedDBOk return true
			function indexedDBOk() {
				return "indexedDB" in window;
			}
			document.addEventListener("DOMContentLoaded", function(){
				//if no support, exits from this function
				if(!indexedDBOk) return;

				// parameter1: db name, 2: version number
				// need to increase the version number each time there's a need to update the db structure
				// db version cannot be lower than the recorded one
				var openRequest = indexedDB.open("test",4);
				openRequest.onupgradeneeded = function(e) {
					console.log("Upgrading...");
					var thisDB = e.target.result;
					//if it doesn't contain the key, it creates a new one
					if(!thisDB.objectStoreNames.contains("objectstore1")) {
						//need to specify a key
						//thisDB.createObjectStore("objectstore1");
						//key is email
						//thisDB.createObjectStore("objectstore1", { keyPath: "email" });
						//key is autogenerated
						var os = thisDB.createObjectStore("objectstore1", { autoIncrement: true });
						//createIndex for searching by name or email
						os.createIndex("name","name", {unique:false});
						os.createIndex("email","email", {unique:true});
					}
				}
				openRequest.onsuccess = function(e) {
					console.log("Success!");
					db = e.target.result;
					//Listen for add clicks
					document.getElementById("addButton").addEventListener("click", addPerson, false);
					document.getElementById("addButton").disabled=false;
					//Listen for get clicks
					document.getElementById("getButton").addEventListener("click", getPerson, false);
					document.getElementById("getButton").disabled=false;
					document.getElementById("getByname").addEventListener("click", getName, false);
					document.getElementById("getByname").disabled=false;
				}
				openRequest.onerror = function(e) {
					console.log("Error");
					console.dir(e);
				}
					
			},false);
			
			function addPerson(e) {
				var name = document.getElementById("name").value;
				var email = document.getElementById("email").value;
			 
				console.log("Adding "+name+"/"+email);
			 
				var transaction = db.transaction(["objectstore1"],"readwrite");
				var store = transaction.objectStore("objectstore1");
			 
				//Define a person
				var person = {
					name:name,
					email:email,
					created:new Date()
				}
			 
				//Perform the add
				//here is with key specified
				//var request = store.add(person,1);
				//here is with key not specified
				var request = store.add(person);
			 
				request.onerror = function(e) {
					console.log("Error",e.target.error.name);
					//some type of error handler
				}
			 
				request.onsuccess = function(e) {
					console.log("Element added");
				}
			}
			
			function getPerson(e) {
				var s = "";
				db.transaction(["objectstore1"], "readonly").objectStore("objectstore1").openCursor().onsuccess = function(e) {
					var cursor = e.target.result;
					if(cursor) {
						s += "<h2>Key "+cursor.key+"</h2><p>";
						for(var field in cursor.value) {
							s+= field+"="+cursor.value[field]+"<br/>";
						}
						s+="</p>";
						cursor.continue();
					}
					document.querySelector("#status").innerHTML = s;
				}
			}
			
			function getName(e) {
				var name = document.querySelector("#nameSearch").value;
				var endname = document.querySelector("#nameSearchEnd").value;

				if(name == "" && endname == "") return;

				var transaction = db.transaction(["objectstore1"],"readonly");
				var store = transaction.objectStore("objectstore1");
				var index = store.index("name");

				//Make the range depending on what type we are doing
				var range;
				if(name != "" && endname != "") {
					range = IDBKeyRange.bound(name, endname);
				} else if(name == "") {
					range = IDBKeyRange.upperBound(endname);
				} else {
					range = IDBKeyRange.lowerBound(name);
				}

				var s = "";

				index.openCursor(range).onsuccess = function(e) {
					var cursor = e.target.result;
					if(cursor) {
						s += "<h2>Key "+cursor.key+"</h2><p>";
						for(var field in cursor.value) {
							s+= field+"="+cursor.value[field]+"<br/>";
						}
						s+="</p>";
						cursor.continue();
					}
					document.querySelector("#status2").innerHTML = s;
				}				
			}
		</script>
	</head>
	<body>
		<p>Please write your name</p>
		<input type="text" id="name" placeholder="Name"><br/>
		<input type="email" id="email" placeholder="Email"><br/>
		<button id="addButton" disabled=true>Add Name</button>
		<br/>
		<br/>
		<button id="getButton" disabled=true>Get Everyone</button><br/>
		<div id="status"></div>
		<p/>
		Starting with: <input type="text" id="nameSearch" placeholder="Name"><br/>
		Ending with: <input type="text" id="nameSearchEnd" placeholder="Name"><br/>
		<button id="getByname" disabled=true">Get By Name</button>
		<p/>
		<div id="status2"></div>
	</body>
</html>



