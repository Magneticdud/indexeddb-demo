<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN" "http://www.w3.org/TR/html4/loose.dtd"> 
<html lang="en">
	<head>
		<meta http-equiv="content-type" content="text/html; charset=utf-8">
		<title>Title Goes Here</title>
		<script type="text/javascript">
			//global variable for indexedDB support
			var idbSupported = false;
			var db;
			//check for indexedDB 
			//if supported, indexedDBOk return true
			function indexedDBOk() {
				return "indexedDB" in window;
			}
			document.addEventListener("DOMContentLoaded", function(){
				//if no support, exits from this function
				if(!indexedDBOk) return;

				// parameter1: db name, 2: version number
				// need to increase the version number each time there's a need to update the db structure
				// db version cannot be lower than the recorded one
				var openRequest = indexedDB.open("test",3);
				openRequest.onupgradeneeded = function(e) {
					console.log("Upgrading...");
					var thisDB = e.target.result;
					//if it doesn't contain the key, it creates a new one
					if(!thisDB.objectStoreNames.contains("objectstore1")) {
						//need to specify a key
						//thisDB.createObjectStore("objectstore1");
						//key is email
						//thisDB.createObjectStore("objectstore1", { keyPath: "email" });
						//key is autogenerated
						thisDB.createObjectStore("objectstore1", { autoIncrement: true });
					}
				}
				openRequest.onsuccess = function(e) {
					console.log("Success!");
					db = e.target.result;
					//Listen for add clicks
					document.getElementById("addButton").addEventListener("click", addPerson, false);
					document.getElementById("addButton").disabled=false;
					//Listen for get clicks
					document.getElementById("getButton").addEventListener("click", getPerson, false);
					document.getElementById("getButton").disabled=false;
				}
				openRequest.onerror = function(e) {
					console.log("Error");
					console.dir(e);
				}
					
			},false);
			
			function addPerson(e) {
				var name = document.getElementById("name").value;
				var email = document.getElementById("email").value;
			 
				console.log("Adding "+name+"/"+email);
			 
				var transaction = db.transaction(["objectstore1"],"readwrite");
				var store = transaction.objectStore("objectstore1");
			 
				//Define a person
				var person = {
					name:name,
					email:email,
					created:new Date()
				}
			 
				//Perform the add
				//here is with key specified
				//var request = store.add(person,1);
				//here is with key not specified
				var request = store.add(person);
			 
				request.onerror = function(e) {
					console.log("Error",e.target.error.name);
					//some type of error handler
				}
			 
				request.onsuccess = function(e) {
					console.log("Element added");
				}
			}
			
			function getPerson(e) {
				var key = document.getElementById("key").value;
				//if invalid key it exits
				if(key === "" || isNaN(key)) return;

				var transaction = db.transaction(["objectstore1"],"readonly");
				var store = transaction.objectStore("objectstore1");
			 
				var request = store.get(Number(key));
			 
				request.onsuccess = function(e) {
			 
					var result = e.target.result;
					console.dir(result);
					if(result) {
						var s = "&lt;h2>Key "+key+"&lt;/h2>&lt;p>";
						for(var field in result) {
							s+= field+"="+result[field]+"&lt;br/>";
						}
						document.getElementById("status").innerHTML = s;
					} else {
						document.getElementById("status").innerHTML = "&lt;h2>No match&lt;/h2>";
					}  
				}  
			}
		</script>
	</head>
	<body>
		<p>Please write your name</p>
		<input type="text" id="name" placeholder="Name"><br/>
		<input type="email" id="email" placeholder="Email"><br/>
		<button id="addButton" disabled=true>Add Name</button>
		<br/>
		<br/>	
		<input type="number" id="key" placeholder="Key"><br/>
		<button id="getButton" disabled=true>Search key</button><br/>
		<div id="status"><h3>No key selected</h3></div>
	</body>
</html>



